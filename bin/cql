#!/usr/bin/env ruby

require 'cql'

def show_help
  puts <<~HELP
        
    \tSYNOPSIS
    \tcql pattern path filters ...

    \tDESCRIPTION
    \tCQL (Code Query Language) is a semantic search tool for your Ruby source code.

    \tEXAMPLES
    \tcql update_user_info ./
  HELP
end

begin
  raise unless ARGV.size >= 2

  # TODO: validate
  pattern = ARGV.shift
  path = ARGV.shift
  filters = ARGV

  # Make it a streamed pipe.
  printer = CQL::ConsolePrinter.new
  collector = CQL::CrumbCollector.new(printer)
  CQL::Executor.new(collector, pattern, path, filters).search_all
rescue => e
  puts "Error: #{e}"
  show_help
end
